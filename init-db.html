<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初始化数据库</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .btn { padding: 12px 24px; background: #1890ff; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        .btn:hover { background: #40a9ff; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #result { margin-top: 20px; padding: 16px; background: #fff; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 14px; line-height: 1.6; max-height: 400px; overflow-y: auto; }
        .success { color: #52c41a; }
        .error { color: #ff4d4f; }
        .info { color: #1890ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>桩基检测劳务管理系统 - 数据库初始化</h1>
        <p style="margin-bottom: 20px; color: #666;">点击下方按钮创建数据库表结构：</p>
        <button class="btn" id="initBtn" onclick="initDatabase()">初始化数据库</button>
        <button class="btn" onclick="loadData()">加载示例数据</button>
        <button class="btn" onclick="clearData()">清空数据</button>
        <div id="result"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fymwdwocxvnduyofwcvi.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_gm6hXPqMEXFz_ZzjFaWHoQ_d-GOV48h';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const log = (msg, type = 'info') => {
            const div = document.getElementById('result');
            const span = document.createElement('div');
            span.className = type;
            span.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
            div.appendChild(span);
            div.scrollTop = div.scrollHeight;
        };
        
        async function initDatabase() {
            const btn = document.getElementById('initBtn');
            btn.disabled = true;
            log('开始创建数据库表...', 'info');
            
            const sql = `
                -- 创建设备类型表
                CREATE TABLE IF NOT EXISTS equipment_types (
                    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    name TEXT NOT NULL,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- 创建设备库存表
                CREATE TABLE IF NOT EXISTS equipment_inventory (
                    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    type_id BIGINT REFERENCES equipment_types(id),
                    type_name TEXT,
                    total_quantity INTEGER DEFAULT 0,
                    project_quantities JSONB DEFAULT '{}',
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- 创建合同/项目表
                CREATE TABLE IF NOT EXISTS contracts (
                    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    name TEXT NOT NULL,
                    status TEXT DEFAULT 'active',
                    overview TEXT,
                    address TEXT,
                    employer TEXT,
                    manager TEXT,
                    phone TEXT,
                    prices JSONB DEFAULT '[]',
                    attachments JSONB DEFAULT '[]',
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- 创建设备流转记录表
                CREATE TABLE IF NOT EXISTS transfer_records (
                    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    transfer_no TEXT,
                    from_project TEXT,
                    to_project TEXT,
                    equipment_type BIGINT,
                    quantity INTEGER,
                    remark TEXT,
                    status TEXT DEFAULT 'pending',
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    completed_at TIMESTAMP WITH TIME ZONE
                );
                
                -- 创建工作量记录表
                CREATE TABLE IF NOT EXISTS work_records (
                    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    work_date DATE,
                    project BIGINT REFERENCES contracts(id),
                    crane_blocks INTEGER DEFAULT 0,
                    crane_beams INTEGER DEFAULT 0,
                    truck_blocks INTEGER DEFAULT 0,
                    truck_beams INTEGER DEFAULT 0,
                    billable_amount NUMERIC DEFAULT 0,
                    remark TEXT,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- 启用 RLS
                ALTER TABLE equipment_types ENABLE ROW LEVEL SECURITY;
                ALTER TABLE equipment_inventory ENABLE ROW LEVEL SECURITY;
                ALTER TABLE contracts ENABLE ROW LEVEL SECURITY;
                ALTER TABLE transfer_records ENABLE ROW LEVEL SECURITY;
                ALTER TABLE work_records ENABLE ROW LEVEL SECURITY;
                
                -- 创建 RLS 策略（允许所有操作）
                CREATE POLICY "允许所有操作" ON equipment_types FOR ALL USING (true);
                CREATE POLICY "允许所有操作" ON equipment_inventory FOR ALL USING (true);
                CREATE POLICY "允许所有操作" ON contracts FOR ALL USING (true);
                CREATE POLICY "允许所有操作" ON transfer_records FOR ALL USING (true);
                CREATE POLICY "允许所有操作" ON work_records FOR ALL USING (true);
            `;
            
            try {
                const { error } = await supabase.rpc('exec_sql', { sql });
                if (error) {
                    // 如果 exec_sql 函数不存在，尝试直接执行
                    log('尝试通过其他方式执行...', 'info');
                    log('请在 Supabase 后台的 SQL Editor 中执行以下 SQL：', 'info');
                    log(sql, 'info');
                    log('', 'info');
                    log('执行步骤：', 'info');
                    log('1. 访问: https://fymwdwocxvnduyofwcvi.supabase.co', 'info');
                    log('2. 点击左侧 "SQL Editor"', 'info');
                    log('3. 粘贴上方 SQL 并点击 "Run"', 'info');
                } else {
                    log('数据库表创建成功！', 'success');
                }
            } catch (err) {
                log('请在 Supabase 后台执行以下 SQL：', 'error');
                log('', 'error');
                log(sql, 'info');
            }
            
            btn.disabled = false;
        }
        
        async function loadData() {
            log('加载示例数据...', 'info');
            
            try {
                // 插入设备类型
                const { data: types, error: typeError } = await supabase
                    .from('equipment_types')
                    .insert([
                        { name: '吊车' },
                        { name: '货车' },
                        { name: '桩基检测仪' },
                        { name: '水泥块吊装设备' }
                    ])
                    .select();
                
                if (typeError) throw typeError;
                log('设备类型插入成功: ' + types.length + ' 条', 'success');
                
                // 插入设备库存
const { data: inventory, error: invError } = await supabase
                    .from('equipment_inventory')
                    .insert([
                        { type_id: 1, type_name: '吊车', total_quantity: 5 },
                        { type_id: 2, type_name: '货车', total_quantity: 8 },
                        { type_id: 3, type_name: '桩基检测仪', total_quantity: 3 },
                        { type_id: 4, type_name: '水泥块吊装设备', total_quantity: 10 }
                    ])
                    .select();
                
                if (invError) throw invError;
                log('设备库存插入成功: ' + inventory.length + ' 条', 'success');
                
                log('示例数据加载完成！', 'success');
            } catch (err) {
                log('加载数据失败: ' + err.message, 'error');
            }
        }
        
        async function clearData() {
            if (!confirm('确定要清空所有数据吗？')) return;
            
            log('清空数据...', 'info');
            
            try {
                await supabase.from('work_records').delete().neq('id', 0);
                await supabase.from('transfer_records').delete().neq('id', 0);
                await supabase.from('contracts').delete().neq('id', 0);
                await supabase.from('equipment_inventory').delete().neq('id', 0);
                await supabase.from('equipment_types').delete().neq('id', 0);
                
                log('数据清空完成！', 'success');
            } catch (err) {
                log('清空数据失败: ' + err.message, 'error');
            }
        }
    </script>
</body>
</html>
